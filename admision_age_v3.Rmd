---
title: "Edad de admisión covid-19"
output:
  word_document: default
  html_notebook: default
---

El objetivo de este trabajo es ver quien se intuba, quien no se intuba, quien se muere sin intubarse y cuáles son los factores asociados a estos desenlaces. 
La hipótesis es que las personas mayores se intuban menos, se mueren más y que la saturación del hospital en particular al que acuden determina si cualquiera recibe tubo o no.

```{r needed packages and saved dataframes, include = F}
library(tidyverse);library(data.table);library(lubridate); library(zoo); library(patchwork);library(survival);library(rms)

#load("base_cdmx_v1.RDa")
Sys.setlocale("LC_ALL", locale= "English")
```

Base de Ciudad de México. Aquí lo importante es obtener quienes fueron intubadxs y en donde, además de si fallecieron o no.
```{r definición de caso CDMX, include = F, run = T, echo = F, warnings= F}
base_cdmx_v1 <- fread("E:/Protocolos de investigación/CDMX/Actas de defunción/sisver_cdmx_27_04_2021_actualizacion_16_04.csv")[,                                                                                                                               fec_defuncion := ymd(fecdef)][, resultado_final := if_else(antigencovid == "POSITIVO" | resdefin == "SARS-CoV-2", T, F)]

#Data for selection flowchart
table(base_cdmx_v1$tipacien)
patients_included_1 <- filter(base_cdmx_v1, tipacien == "HOSPITALIZADO")

#MEDIANA de tiempo con síntomas al momento de la muerte en pacientes que se murieron sin tubo

mediana_sint_muerte <- filter(patients_included_1, intubado == "NO" & !is.na(fec_defuncion)) %>% 
  mutate(mediana_s_m = as.numeric(fec_defuncion - ymd(fecinisi))) %>% 
  summarise(mediana = median(mediana_s_m))
#11 días


mediana_ingreso_muerte <- filter(patients_included_1, intubado == "NO" & !is.na(fec_defuncion)) %>% 
  mutate(mediana_i_m = as.numeric(fec_defuncion - ymd(fecingre))) %>% 
  summarise(mediana = median(mediana_i_m))
#5 días

mediana_sintomas_ingreso <- filter(patients_included_1, intubado == "NO" & !is.na(fec_defuncion)) %>% 
  mutate(mediana_i_m = as.numeric(ymd(fecingre) - ymd(fecinisi))) %>% 
  summarise(mediana = median(mediana_i_m))
#5 días


hosp_vivieron <- filter(patients_included_1, is.na(fec_defuncion)) %>%
  mutate(fecinisi=ymd(fecinisi),
         lugarmuerte = NA,
         fecingre = ymd(fecingre)) %>% 
  select(fecinisi, fecingre, fec_defuncion, sexo, edad,lugarmuerte) 
  
```

Base de actas de defunción. Aquí lo importante es determinar si las fechas son iguales a las que se reportan en la base de covid de la SISVER y si las defunciones fueron o no fueron en casa.
```{r actas, include = F, warning = F}
base_actas_v1 <- fread("E:/Protocolos de investigación/CDMX/Defunciones corte 15 de marzo 2021/defunciones_corte15marzo.csv")[, sexo := if_else(sexo == "Mujer", "FEMENINO", "MASCULINO")][,
  fec_defuncion := ymd(fec_defuncion)
][,tipacien := if_else(lugarmuerte == "Hospital", "HOSPITALIZADO", "AMBULATORIO")][causa != "Otra",][, entresi := estado][,mpioresi:=alcaldia][,`:=`(fecinisi=fec_defuncion-11,
                                                                                                                                                     fecingre=fec_defuncion-5)][,
                                                                                                                                                                                        .(fecinisi, fecingre, fec_defuncion,
                                                                                                                                                                      sexo,edad,lugarmuerte,causa_registro, estado, alcaldia)][,`:=`(
                                                                                                                                                                        enfermedad_cardio_vascular = case_when(str_detect(causa_registro, "INFARTO")~T,
                                                                                                                                                                                                        str_detect(causa_registro, "CHOQUE CARDIOGENICO")~T,
                                                                                                                                                                                                        str_detect(causa_registro, "INSUFICIENCIA CARDIACA")~T,
                                                                                                                                                                                                        str_detect(causa_registro, "EVENTO VASCULAR")~T,
                                                                                                                                                                                                        str_detect(causa_registro, "CARDIOPATIA ISQUEMICA")~T,
                                                                                                                                                                                                        str_detect(causa_registro, "ANEURISMA")~T),
                                                                                                                                                                        cancer = case_when(str_detect(causa_registro, "CANCER")~T,
                                                                                                                                                                                           str_detect(causa_registro, "NEOPLASIA")~T,
                                                                                                                                                                                           str_detect(causa_registro, "TUMOR")~T,
                                                                                                                                                                                           str_detect(causa_registro, "TUMORACION")~T,
                                                                                                                                                                                           str_detect(causa_registro, "LINFOMA")~T,
                                                                                                                                                                                           str_detect(causa_registro, "LEUCEMIA")~T,
                                                                                                                                                                                           str_detect(causa_registro, "METASTASIS")~T,
                                                                                                                                                                                           str_detect(causa_registro, "CARCINOMA")~T,
                                                                                                                                                                                           str_detect(causa_registro, "GLIOBLASTOMA")~T,
                                                                                                                                                                                           str_detect(causa_registro, "MIELODISPLASICO")~T,
                                                                                                                                                                                           str_detect(causa_registro, "MIELOMA")~T),
                                                                                                                                                                        enf_renal_cronica = case_when(str_detect(causa_registro, "ENFERMEDAD RENAL CRONICA")~T,
                                                                                                                                                                                                      str_detect(causa_registro, "INSUFICIENCIA RENAL CRONICA")~T,
                                                                                                                                                                                                      str_detect(causa_registro, "ENFRMEDAD RENAL CRONICA")~T),
                                                                                                                                                                        cirrosis = case_when(str_detect(causa_registro, "CIRROSIS")~T,
                                                                                                                                                                                             str_detect(causa_registro, "HEPATORRENAL")~T,
                                                                                                                                                                                             str_detect(causa_registro, "INSUFICIENCIA HEPATICA")~T),
                                                                                                                                                                        epoc = case_when(str_detect(causa_registro, "ENFERMEDAD PULMONAR OBSTRUCTIVA")~T),
                                                                                                                                                                        diabetes = case_when(str_detect(causa_registro, "DIABETES")~T,
                                                                                                                                                                                             str_detect(causa_registro, "MELLITUS")~T),
                                                                                                                                                                        hipertension = case_when(str_detect(causa_registro, "HIPERTENSION")~T,
                                                                                                                                                                                                 str_detect(causa_registro, "HIPERENSION ARTERIAL")~T,
                                                                                                                                                                                                 str_detect(causa_registro, "HIERTENSION ARTERIAL")~T))
                                                                                                                                                                        ][,distrito:=ifelse(!is.na(alcaldia), alcaldia, ifelse(is.na(alcaldia)&estado != "CIUDAD DE MEXICO", "Fuera de cdmx", "Desconocido"))] 


```

```{r capacidad hospitalaria, include = F, warning=F}
base_capacidad_v1 <- fread("E:/Protocolos de investigación/CDMX/capacidad_hospitalaria_micrositio_cdmx.csv")

n_distinct(base_capacidad_v1$Nombre_hospital)
table(base_cdmx_v1$unidad[base_cdmx_v1$tipacien == "HOSPITALIZADO"])

`%!in%` <- Negate(`%in%`)

#Base ocupación de cada sistema de salud
base_ocupacion_manual <- read_csv("~/Protocolos de investigación/Intubacion covid mexico/intubacion_covid/base_ocupacion_manual.csv") %>% 
  rename(porcentaje_disponibles = porcentaje) %>% 
  mutate(fecha = dmy(fecha),
         num_fila = row_number())
 
intermed <-  base_ocupacion_manual %>% 
  filter(fecha>=dmy("06-01-2021") & sector =="privados") 
  
base_ocupacion_manual_2 <- base_ocupacion_manual %>% 
  filter(num_fila %!in% intermed$num_fila) %>% 
  group_by(sector, tipo_cama, fecha) %>% 
  arrange(.by_group = T) %>% 
  ungroup() %>% 
  mutate(disponibles_mod = if_else(!is.na(disponibles), disponibles, 
                                 round((na.locf(disponibles, fromLast = F)+
                                   na.locf(disponibles, fromLast = T))/2,0)),
         porcentaje_disponibles_mod = if_else(!is.na(porcentaje_disponibles), 
                                              porcentaje_disponibles, 
                                 round((na.locf(porcentaje_disponibles, fromLast = F)+
                                   na.locf(porcentaje_disponibles, fromLast = T))/2,1)),
         porcentaje_ocupadas = 100-porcentaje_disponibles,
         capacidad = round((disponibles*100)/porcentaje_disponibles, 0),
         porcentaje_ocupadas_mod = 100-porcentaje_disponibles_mod,
         capacidad_mod = round((disponibles_mod*100)/porcentaje_disponibles_mod, 0)) %>% 
  filter(sector == "cdmx")
         
```


```{r base de trabajo, include = F}
base_trabajo <- base_actas_v1 %>% 
  filter(fec_defuncion >="18-03-2020"|is.na(fec_defuncion)) %>% 
  mutate(muerte = if_else(!is.na(fec_defuncion), T, F),
         semana_epi = if_else(year(fec_defuncion)== 2020, week(fec_defuncion),week(fec_defuncion)+53)) %>% 
  filter(!is.na(lugarmuerte))


base_final <- base_trabajo %>% 
  mutate(no_hospitalizado = case_when(lugarmuerte=="Hospital"~F,
                                   lugarmuerte=="Domicilio"~T)) %>% 
  filter(muerte==T) %>% 
  mutate(fecha = fec_defuncion) %>% 
  left_join(filter(base_ocupacion_manual_2, tipo_cama == "iot") %>% 
              rename(porcentaje_ocupadas_uti_misma_fecha = porcentaje_ocupadas_mod) %>% 
              select(porcentaje_ocupadas_uti_misma_fecha, fecha), by = "fecha") %>% 
  left_join(filter(base_ocupacion_manual_2, tipo_cama == "iot") %>%
              mutate(fecha = fecha-3) %>% 
              rename(porcentaje_ocupadas_uti_fecha_3 = porcentaje_ocupadas_mod) %>% 
              select(porcentaje_ocupadas_uti_fecha_3, fecha), by = "fecha") %>% 
  left_join(filter(base_ocupacion_manual_2, tipo_cama == "iot") %>%
              mutate(fecha = fecha-7) %>% 
              rename(porcentaje_ocupadas_uti_fecha_7 = porcentaje_ocupadas_mod) %>% 
              select(porcentaje_ocupadas_uti_fecha_7, fecha), by = "fecha") %>% 
  left_join(filter(base_ocupacion_manual_2, tipo_cama == "general") %>%
              rename(porcentaje_ocupadas_general_misma_fecha = porcentaje_ocupadas_mod) %>% 
              select(porcentaje_ocupadas_general_misma_fecha, fecha), by = "fecha") %>% 
  left_join(filter(base_ocupacion_manual_2, tipo_cama == "general") %>%
              mutate(fecha = fecha-3) %>% 
              rename(porcentaje_ocupadas_general_fecha_3 = porcentaje_ocupadas_mod) %>% 
              select(porcentaje_ocupadas_general_fecha_3, fecha), by = "fecha") %>% 
  left_join(filter(base_ocupacion_manual_2, tipo_cama == "general") %>%
              mutate(fecha = fecha-7) %>% 
              rename(porcentaje_ocupadas_general_fecha_7 = porcentaje_ocupadas_mod) %>% 
              select(porcentaje_ocupadas_general_fecha_7, fecha), by = "fecha") %>% 
  mutate(enfermedad_cardio_vascular = ifelse(!is.na(enfermedad_cardio_vascular), T, F),
         cancer = ifelse(!is.na(cancer), T, F),
         enf_renal_cronica = ifelse(!is.na(enf_renal_cronica), T, F),
         cirrosis = ifelse(!is.na(cirrosis), T, F),
         epoc = ifelse(!is.na(epoc), T, F),
         diabetes = ifelse(!is.na(diabetes), T, F),
         hipertension = ifelse(!is.na(hipertension), T, F),
         id = row_number()) %>% 
  group_by(id) %>% 
         mutate(numero_comorbilidades = sum(enfermedad_cardio_vascular,cancer, enf_renal_cronica,cirrosis,
                                     epoc,diabetes,hipertension),
                numero_comorbilidades_factor = factor(numero_comorbilidades, levels = c("0", "1", "2", "3", "4")),
                tiene_comorbilidad = if_else(numero_comorbilidades>0, T, F),
                cardiovasc_diabetes = if_else(diabetes ==T | hipertension == T | 
                                                enfermedad_cardio_vascular==T, T, F),
                renal_cirrosis_epoc = if_else(enf_renal_cronica==T|cirrosis == T|
                                                epoc ==T, T, F))
      


```


```{r  log regression out-of-hospital death as outcome AGE, include = F, warning= F}
set.seed(12345)

ind <- sample(c(0,1), nrow(base_final), replace = T, prob= c(0.7, 0.3))

train <- base_final[ind==1,]
test <- base_final[ind==2,]



#EDAD DESENLACE HOSPITALIZACIÓN SATURACION HOSPITALARIA INTUBACION MISMA FECHA

mymodel_edad <- glm(no_hospitalizado ~ rcs(edad, 3)+semana_epi+rcs(porcentaje_ocupadas_uti_misma_fecha, 3)+tiene_comorbilidad+sexo+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_edad)
exp(coef(mymodel_edad))
exp(coef(mymodel_edad)-(1.96*0.003))
exp(coef(mymodel_edad)+(1.96*0.003))

lr_edad <- termplot(mymodel_edad, se=TRUE, plot = F)$edad
center_edad <- with(lr_edad, y[x==60])
ci_edad <- lr_edad$y + outer(lr_edad$se, c(0, -1.96, 1.96), '*')

edad_df <- data.frame(edad = lr_edad$x, 
                     y = lr_edad$y,
                     se = lr_edad$se,
                     lower_ci = ci_edad[,2],
                     upper_ci = ci_edad[,3],
                     mean_ci = ci_edad[,1])


edad_ors <- edad_df[with(edad_df, edad == 20 | edad == 30 | edad == 40 | 
                         edad == 50 |edad== 60|edad== 70|edad== 80|edad== 90),] %>% 
  mutate(or = round(exp(y-center_edad),2),
         lower_or = round(exp(lower_ci-center_edad),2),
         upper_or = round(exp(upper_ci-center_edad),2),
         full_or = str_c(round(exp(y-center_edad),2), " (", round(exp(lower_ci-center_edad),2),
                         "-", round(exp(upper_ci-center_edad),2),")"))

#EDAD DESENLACE HOSPITALIZACIÓN SATURACION HOSPITALARIA INTUBACION FECHA -3 DÍAS

mymodel_edad_fecha_3 <- glm(no_hospitalizado ~ rcs(edad, 3)+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_3, 3)+tiene_comorbilidad+sexo+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_edad)


lr_edad_fecha_3 <- termplot(mymodel_edad_fecha_3, se=TRUE, plot = F)$edad
center_edad_fecha_3 <- with(lr_edad_fecha_3, y[x==60])
ci_edad_fecha_3 <- lr_edad_fecha_3$y + outer(lr_edad_fecha_3$se, c(0, -1.96, 1.96), '*')

edad_df_fecha_3 <- data.frame(edad = lr_edad_fecha_3$x, 
                     y = lr_edad_fecha_3$y,
                     se = lr_edad_fecha_3$se,
                     lower_ci = ci_edad_fecha_3[,2],
                     upper_ci = ci_edad_fecha_3[,3],
                     mean_ci = ci_edad_fecha_3[,1])


edad_ors_fecha_3 <- edad_df_fecha_3[with(edad_df_fecha_3, edad == 20 | edad == 30 | edad == 40 | 
                         edad == 50 |edad== 60|edad== 70|edad== 80|edad== 90),] %>% 
  mutate(or = round(exp(y-center_edad_fecha_3),2),
         lower_or = round(exp(lower_ci-center_edad_fecha_3),2),
         upper_or = round(exp(upper_ci-center_edad_fecha_3),2),
         full_or = str_c(round(exp(y-center_edad_fecha_3),2), " (", round(exp(lower_ci-center_edad_fecha_3),2),
                         "-", round(exp(upper_ci-center_edad_fecha_3),2),")"))

#EDAD DESENLACE HOSPITALIZACIÓN SATURACION HOSPITALARIA INTUBACION FECHA -7 DÍAS

mymodel_edad_fecha_7 <- glm(no_hospitalizado ~ rcs(edad, 3)+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_7, 3)+tiene_comorbilidad+sexo+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_edad)


lr_edad_fecha_7 <- termplot(mymodel_edad_fecha_7, se=TRUE, plot = F)$edad
center_edad_fecha_7 <- with(lr_edad_fecha_7, y[x==60])
ci_edad_fecha_7 <- lr_edad_fecha_7$y + outer(lr_edad_fecha_7$se, c(0, -1.96, 1.96), '*')

edad_df_fecha_7 <- data.frame(edad = lr_edad_fecha_7$x, 
                     y = lr_edad_fecha_7$y,
                     se = lr_edad_fecha_7$se,
                     lower_ci = ci_edad_fecha_7[,2],
                     upper_ci = ci_edad_fecha_7[,3],
                     mean_ci = ci_edad_fecha_7[,1])


edad_ors_fecha_7 <- edad_df_fecha_7[with(edad_df_fecha_7, edad == 20 | edad == 30 | edad == 40 | 
                         edad == 50 |edad== 60|edad== 70|edad== 80|edad== 90),] %>% 
  mutate(or = round(exp(y-center_edad_fecha_3),2),
         lower_or = round(exp(lower_ci-center_edad_fecha_7),2),
         upper_or = round(exp(upper_ci-center_edad_fecha_7),2),
         full_or = str_c(round(exp(y-center_edad_fecha_7),2), " (", round(exp(lower_ci-center_edad_fecha_7),2),
                         "-", round(exp(upper_ci-center_edad_fecha_7),2),")"))

###########################################################################


#EDAD DESENLACE HOSPITALIZACIÓN SATURACION HOSPITALARIA GENERAL MISMA FECHA

mymodel_edad_gr <- glm(no_hospitalizado ~ rcs(edad, 3)+semana_epi+rcs(porcentaje_ocupadas_general_misma_fecha, 3)+tiene_comorbilidad+sexo+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_edad_gr)


lr_edad_gr <- termplot(mymodel_edad_gr, se=TRUE, plot = F)$edad
center_edad_gr <- with(lr_edad_gr, y[x==60])
ci_edad_gr <- lr_edad_gr$y + outer(lr_edad_gr$se, c(0, -1.96, 1.96), '*')

edad_df_gr <- data.frame(edad = lr_edad_gr$x, 
                     y = lr_edad_gr$y,
                     se = lr_edad_gr$se,
                     lower_ci = ci_edad_gr[,2],
                     upper_ci = ci_edad_gr[,3],
                     mean_ci = ci_edad_gr[,1])


edad_ors_gr <- edad_df_gr[with(edad_df_gr, edad == 20 | edad == 30 | edad == 40 | 
                         edad == 50 |edad== 60|edad== 70|edad== 80|edad== 90),] %>% 
  mutate(or = round(exp(y-center_edad_gr),2),
         lower_or = round(exp(lower_ci-center_edad_gr),2),
         upper_or = round(exp(upper_ci-center_edad_gr),2),
         full_or = str_c(round(exp(y-center_edad_gr),2), " (", round(exp(lower_ci-center_edad_gr),2),
                         "-", round(exp(upper_ci-center_edad_gr),2),")"))

#EDAD DESENLACE HOSPITALIZACIÓN SATURACION HOSPITALARIA INTUBACION FECHA -3 DÍAS

mymodel_edad_fecha_3_gr <- glm(no_hospitalizado ~ rcs(edad, 3)+semana_epi+rcs(porcentaje_ocupadas_general_fecha_3, 3)+tiene_comorbilidad+sexo+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_edad)


lr_edad_fecha_3_gr <- termplot(mymodel_edad_fecha_3_gr, se=TRUE, plot = F)$edad
center_edad_fecha_3_gr <- with(lr_edad_fecha_3_gr, y[x==60])
ci_edad_fecha_3_gr <- lr_edad_fecha_3_gr$y + outer(lr_edad_fecha_3_gr$se, c(0, -1.96, 1.96), '*')

edad_df_fecha_3_gr <- data.frame(edad = lr_edad_fecha_3_gr$x, 
                     y = lr_edad_fecha_3_gr$y,
                     se = lr_edad_fecha_3_gr$se,
                     lower_ci = ci_edad_fecha_3_gr[,2],
                     upper_ci = ci_edad_fecha_3_gr[,3],
                     mean_ci = ci_edad_fecha_3_gr[,1])


edad_ors_fecha_3_gr <- edad_df_fecha_3_gr[with(edad_df_fecha_3_gr, edad == 20 | edad == 30 | edad == 40 | 
                         edad == 50 |edad== 60|edad== 70|edad== 80|edad== 90),] %>% 
  mutate(or = round(exp(y-center_edad_fecha_3_gr),2),
         lower_or = round(exp(lower_ci-center_edad_fecha_3_gr),2),
         upper_or = round(exp(upper_ci-center_edad_fecha_3_gr),2),
         full_or = str_c(round(exp(y-center_edad_fecha_3_gr),2), " (", round(exp(lower_ci-center_edad_fecha_3_gr),2),
                         "-", round(exp(upper_ci-center_edad_fecha_3_gr),2),")"))

#EDAD DESENLACE HOSPITALIZACIÓN SATURACION HOSPITALARIA INTUBACION FECHA -7 DÍAS

mymodel_edad_fecha_7_gr <- glm(no_hospitalizado ~ rcs(edad, 3)+semana_epi+rcs(porcentaje_ocupadas_general_fecha_7, 3)+tiene_comorbilidad+sexo+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_edad)


lr_edad_fecha_7_gr <- termplot(mymodel_edad_fecha_7_gr, se=TRUE, plot = F)$edad
center_edad_fecha_7_gr <- with(lr_edad_fecha_7_gr, y[x==60])
ci_edad_fecha_7_gr <- lr_edad_fecha_7$y + outer(lr_edad_fecha_7_gr$se, c(0, -1.96, 1.96), '*')

edad_df_fecha_7_gr <- data.frame(edad = lr_edad_fecha_7_gr$x, 
                     y = lr_edad_fecha_7_gr$y,
                     se = lr_edad_fecha_7_gr$se,
                     lower_ci = ci_edad_fecha_7_gr[,2],
                     upper_ci = ci_edad_fecha_7_gr[,3],
                     mean_ci = ci_edad_fecha_7_gr[,1])


edad_ors_fecha_7_gr <- edad_df_fecha_7_gr[with(edad_df_fecha_7_gr, edad == 20 | edad == 30 | edad == 40 | 
                         edad == 50 |edad== 60|edad== 70|edad== 80|edad== 90),] %>% 
  mutate(or = round(exp(y-center_edad_fecha_3_gr),2),
         lower_or = round(exp(lower_ci-center_edad_fecha_7_gr),2),
         upper_or = round(exp(upper_ci-center_edad_fecha_7_gr),2),
         full_or = str_c(round(exp(y-center_edad_fecha_7_gr),2), " (", round(exp(lower_ci-center_edad_fecha_7_gr),2),
                         "-", round(exp(upper_ci-center_edad_fecha_7_gr),2),")"))
```


```{r  log regression out-of-hospital death as outcome SEX, include = F, warning= F}
############################################################################
#SEXO INTUBACION MISMO DIA
mymodel_sex <- glm(no_hospitalizado ~ sexo+semana_epi+rcs(porcentaje_ocupadas_uti_misma_fecha, 3)+tiene_comorbilidad+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_sex)


sex_or <- c(round(exp(coef(mymodel_sex)),2)[2],
                             round(exp(coef(mymodel_sex)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_sex)+(1.96*0.05)),2)[2])

sex_or_ic <- str_c(round(exp(coef(mymodel_sex)),2)[2],
                            " (", round(exp(coef(mymodel_sex)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_sex)+(1.96*0.05)),2)[2],")")

#SEXO INTUBACION -3
mymodel_sex_iot_3 <- glm(no_hospitalizado ~ sexo+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_3, 3)+tiene_comorbilidad+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_sex_iot_3)


sex_iot_3_or <- c(round(exp(coef(mymodel_sex_iot_3)),2)[2],
                             round(exp(coef(mymodel_sex_iot_3)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_sex_iot_3)+(1.96*0.05)),2)[2])

sex_iot_3_or_ic <- str_c(round(exp(coef(mymodel_sex_iot_3)),2)[2],
                            " (", round(exp(coef(mymodel_sex_iot_3)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_sex_iot_3)+(1.96*0.05)),2)[2],")")

#SEXO INTUBACION -7
mymodel_sex_iot_7 <- glm(no_hospitalizado ~ sexo+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_7, 3)+tiene_comorbilidad+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_sex_iot_7)


sex_iot_7_or <- c(round(exp(coef(mymodel_sex_iot_7)),2)[2],
                             round(exp(coef(mymodel_sex_iot_7)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_sex_iot_7)+(1.96*0.05)),2)[2])

sex_iot_7_or_ic <- str_c(round(exp(coef(mymodel_sex_iot_7)),2)[2],
                            " (", round(exp(coef(mymodel_sex_iot_7)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_sex_iot_7)+(1.96*0.05)),2)[2],")")

#SEXO GENERALES MISMO DIA
mymodel_sex_gral <- glm(no_hospitalizado ~ sexo+semana_epi+rcs(porcentaje_ocupadas_general_misma_fecha, 3)+tiene_comorbilidad+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_sex_gral)


sex_gral_or <- c(round(exp(coef(mymodel_sex_gral)),2)[2],
                             round(exp(coef(mymodel_sex_gral)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_sex_gral)+(1.96*0.05)),2)[2])

sex_gral_or_ic <- str_c(round(exp(coef(mymodel_sex_gral)),2)[2],
                            " (", round(exp(coef(mymodel_sex_gral)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_sex_gral)+(1.96*0.05)),2)[2],")")


#SEXO GENERALES -3
mymodel_sex_gral_3 <- glm(no_hospitalizado ~ sexo+semana_epi+rcs(porcentaje_ocupadas_general_fecha_3, 3)+tiene_comorbilidad+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_sex_gral_3)


sex_gral_3_or <- c(round(exp(coef(mymodel_sex_gral_3)),2)[2],
                             round(exp(coef(mymodel_sex_gral_3)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_sex_gral_3)+(1.96*0.05)),2)[2])

sex_gral_3_or_ic <- str_c(round(exp(coef(mymodel_sex_gral_3)),2)[2],
                            " (", round(exp(coef(mymodel_sex_gral_3)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_sex_gral_3)+(1.96*0.05)),2)[2],")")

#SEXO GENERALES -7
mymodel_sex_gral_7 <- glm(no_hospitalizado ~ sexo+semana_epi+rcs(porcentaje_ocupadas_general_fecha_7, 3)+tiene_comorbilidad+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_sex_gral_7)


sex_gral_7_or <- c(round(exp(coef(mymodel_sex_gral_7)),2)[2],
                             round(exp(coef(mymodel_sex_gral_7)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_sex_gral_7)+(1.96*0.05)),2)[2])

sex_gral_7_or_ic <- str_c(round(exp(coef(mymodel_sex_gral_7)),2)[2],
                            " (", round(exp(coef(mymodel_sex_gral_7)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_sex_gral_7)+(1.96*0.05)),2)[2],")")
```


```{r  log regression out-of-hospital death as outcome CARDIOVASCULAR OR DIABETES, include = F, warning= F}
############################################################################
#CV-DIABETES INTUBACION MISMO DIA
mymodel_cv <- glm(no_hospitalizado ~ cardiovasc_diabetes+sexo+semana_epi+rcs(porcentaje_ocupadas_uti_misma_fecha, 3)+cancer+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cv)


cv_or <- c(round(exp(coef(mymodel_cv)),2)[2],
                             round(exp(coef(mymodel_cv)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_cv)+(1.96*0.05)),2)[2])

cv_or_ic <- str_c(round(exp(coef(mymodel_cv)),2)[2],
                            " (", round(exp(coef(mymodel_cv)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_cv)+(1.96*0.05)),2)[2],")")

#CV-DIABETES INTUBACION -3
mymodel_cv_iot_3 <- glm(no_hospitalizado ~ cardiovasc_diabetes+sexo+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_3, 3)+cancer+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cv_iot_3)


cv_iot_3_or <- c(round(exp(coef(mymodel_cv_iot_3)),2)[2],
                             round(exp(coef(mymodel_cv_iot_3)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_cv_iot_3)+(1.96*0.05)),2)[2])

cv_iot_3_or_ic <- str_c(round(exp(coef(mymodel_cv_iot_3)),2)[2],
                            " (", round(exp(coef(mymodel_cv_iot_3)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_cv_iot_3)+(1.96*0.05)),2)[2],")")

#CV-DIABETES INTUBACION -7
mymodel_cv_iot_7 <- glm(no_hospitalizado ~ cardiovasc_diabetes+sexo+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_7, 3)+cancer+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cv_iot_7)


cv_iot_7_or <- c(round(exp(coef(mymodel_cv_iot_7)),2)[2],
                             round(exp(coef(mymodel_cv_iot_7)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_cv_iot_7)+(1.96*0.05)),2)[2])

cv_iot_7_or_ic <- str_c(round(exp(coef(mymodel_cv_iot_7)),2)[2],
                            " (", round(exp(coef(mymodel_cv_iot_7)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_cv_iot_7)+(1.96*0.05)),2)[2],")")


#CV-DIABETES GENERALES MISMA FECHA
mymodel_cv_gral <- glm(no_hospitalizado ~ cardiovasc_diabetes+sexo+semana_epi+rcs(porcentaje_ocupadas_general_misma_fecha, 3)+cancer+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cv_gral)


cv_gral_or <- c(round(exp(coef(mymodel_cv_gral)),2)[2],
                             round(exp(coef(mymodel_cv_gral)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_cv_gral)+(1.96*0.05)),2)[2])

cv_gral_or_ic <- str_c(round(exp(coef(mymodel_cv_gral)),2)[2],
                            " (", round(exp(coef(mymodel_cv_gral)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_cv_gral)+(1.96*0.05)),2)[2],")")

#CV-DIABETES GENERALES -3
mymodel_cv_gral_3 <- glm(no_hospitalizado ~ cardiovasc_diabetes+sexo+semana_epi+rcs(porcentaje_ocupadas_general_fecha_3, 3)+cancer+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cv_gral_3)


cv_gral_3_or <- c(round(exp(coef(mymodel_cv_gral_3)),2)[2],
                             round(exp(coef(mymodel_cv_gral_3)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_cv_gral_3)+(1.96*0.05)),2)[2])

cv_gral_3_or_ic <- str_c(round(exp(coef(mymodel_cv_gral_3)),2)[2],
                            " (", round(exp(coef(mymodel_cv_gral_3)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_cv_gral_3)+(1.96*0.05)),2)[2],")")


#CV-DIABETES GENERALES -7
mymodel_cv_gral_7 <- glm(no_hospitalizado ~ cardiovasc_diabetes+sexo+semana_epi+rcs(porcentaje_ocupadas_general_fecha_7, 3)+cancer+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cv_gral_7)


cv_gral_7_or <- c(round(exp(coef(mymodel_cv_gral_7)),2)[2],
                             round(exp(coef(mymodel_cv_gral_7)-(1.96*0.05)),2)[2],
                            round(exp(coef(mymodel_cv_gral_7)+(1.96*0.05)),2)[2])

cv_gral_7_or_ic <- str_c(round(exp(coef(mymodel_cv_gral_7)),2)[2],
                            " (", round(exp(coef(mymodel_cv_gral_7)-(1.96*0.05)),2)[2], "-",
                            round(exp(coef(mymodel_cv_gral_7)+(1.96*0.05)),2)[2],")")
```


```{r  log regression out-of-hospital death as outcome CANCER, include = F, warning= F}
############################################################################
#CANCER INTUBACION MISMO DIA
mymodel_cancer <- glm(no_hospitalizado ~ cancer+sexo+semana_epi+rcs(porcentaje_ocupadas_uti_misma_fecha, 3)+cardiovasc_diabetes+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cancer)


cancer_or <- c(round(exp(coef(mymodel_cancer)),2)[2],
                             round(exp(coef(mymodel_cancer)-(1.96*0.23)),2)[2],
                            round(exp(coef(mymodel_cancer)+(1.96*0.23)),2)[2])

cancer_or_ic <- str_c(round(exp(coef(mymodel_cancer)),2)[2],
                            " (", round(exp(coef(mymodel_cancer)-(1.96*0.23)),2)[2], "-",
                            round(exp(coef(mymodel_cancer)+(1.96*0.23)),2)[2],")")


#CANCER INTUBACION -3
mymodel_cancer_iot_3 <- glm(no_hospitalizado ~ cancer+sexo+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_3, 3)+cardiovasc_diabetes+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cancer_iot_3)


cancer_iot_3_or <- c(round(exp(coef(mymodel_cancer_iot_3)),2)[2],
                             round(exp(coef(mymodel_cancer_iot_3)-(1.96*0.23)),2)[2],
                            round(exp(coef(mymodel_cancer_iot_3)+(1.96*0.23)),2)[2])

cancer_iot_3_or_ic <- str_c(round(exp(coef(mymodel_cancer_iot_3)),2)[2],
                            " (", round(exp(coef(mymodel_cancer_iot_3)-(1.96*0.23)),2)[2], "-",
                            round(exp(coef(mymodel_cancer_iot_3)+(1.96*0.23)),2)[2],")")


#CANCER INTUBACION -7
mymodel_cancer_iot_7 <- glm(no_hospitalizado ~ cancer+sexo+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_7, 3)+cardiovasc_diabetes+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cancer_iot_7)


cancer_iot_7_or <- c(round(exp(coef(mymodel_cancer_iot_7)),2)[2],
                             round(exp(coef(mymodel_cancer_iot_7)-(1.96*0.23)),2)[2],
                            round(exp(coef(mymodel_cancer_iot_7)+(1.96*0.23)),2)[2])

cancer_iot_7_or_ic <- str_c(round(exp(coef(mymodel_cancer_iot_7)),2)[2],
                            " (", round(exp(coef(mymodel_cancer_iot_7)-(1.96*0.23)),2)[2], "-",
                            round(exp(coef(mymodel_cancer_iot_7)+(1.96*0.23)),2)[2],")")

#CANCER GENERAL MISMO DIA
mymodel_cancer_gral <- glm(no_hospitalizado ~ cancer+sexo+semana_epi+rcs(porcentaje_ocupadas_general_misma_fecha, 3)+cardiovasc_diabetes+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cancer_gral)


cancer_gral_or <- c(round(exp(coef(mymodel_cancer_gral)),2)[2],
                             round(exp(coef(mymodel_cancer_gral)-(1.96*0.23)),2)[2],
                            round(exp(coef(mymodel_cancer_gral)+(1.96*0.23)),2)[2])

cancer_gral_or_ic <- str_c(round(exp(coef(mymodel_cancer_gral)),2)[2],
                            " (", round(exp(coef(mymodel_cancer_gral)-(1.96*0.23)),2)[2], "-",
                            round(exp(coef(mymodel_cancer_gral)+(1.96*0.23)),2)[2],")")


#CANCER GENERAL -3
mymodel_cancer_gral_3 <- glm(no_hospitalizado ~ cancer+sexo+semana_epi+rcs(porcentaje_ocupadas_general_fecha_3, 3)+cardiovasc_diabetes+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cancer_gral_3)


cancer_gral_3_or <- c(round(exp(coef(mymodel_cancer_gral_3)),2)[2],
                             round(exp(coef(mymodel_cancer_gral_3)-(1.96*0.23)),2)[2],
                            round(exp(coef(mymodel_cancer_gral_3)+(1.96*0.23)),2)[2])

cancer_gral_3_or_ic <- str_c(round(exp(coef(mymodel_cancer_gral_3)),2)[2],
                            " (", round(exp(coef(mymodel_cancer_gral_3)-(1.96*0.23)),2)[2], "-",
                            round(exp(coef(mymodel_cancer_gral_3)+(1.96*0.23)),2)[2],")")


#CANCER GENERAL -7
mymodel_cancer_gral_7 <- glm(no_hospitalizado ~ cancer+sexo+semana_epi+rcs(porcentaje_ocupadas_general_fecha_7, 3)+cardiovasc_diabetes+renal_cirrosis_epoc+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_cancer_gral_7)


cancer_gral_7_or<- c(round(exp(coef(mymodel_cancer_gral_7)),2)[2],
                             round(exp(coef(mymodel_cancer_gral_7)-(1.96*0.23)),2)[2],
                            round(exp(coef(mymodel_cancer_gral_7)+(1.96*0.23)),2)[2])

cancer_gral_7_or_ic <- str_c(round(exp(coef(mymodel_cancer_gral_7)),2)[2],
                            " (", round(exp(coef(mymodel_cancer_gral_7)-(1.96*0.23)),2)[2], "-",
                            round(exp(coef(mymodel_cancer_gral_7)+(1.96*0.23)),2)[2],")")
```


```{r  log regression out-of-hospital death as outcome CIRROSIS-ERC-EPOC, include = F, warning= F}
############################################################################
#CIRROSIS-ERC-EPOC INTUBACION MISMO DIA
mymodel_erc <- glm(no_hospitalizado ~ renal_cirrosis_epoc+sexo+semana_epi+rcs(porcentaje_ocupadas_uti_misma_fecha, 3)+cardiovasc_diabetes+cancer+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_erc)


erc_or <- c(round(exp(coef(mymodel_erc)),2)[2],
                             round(exp(coef(mymodel_erc)-(1.96*0.12)),2)[2],
                            round(exp(coef(mymodel_erc)+(1.96*0.12)),2)[2])

erc_or_ic <- str_c(round(exp(coef(mymodel_erc)),2)[2],
                            " (", round(exp(coef(mymodel_erc)-(1.96*0.12)),2)[2], "-",
                            round(exp(coef(mymodel_erc)+(1.96*0.12)),2)[2],")")


#CIRROSIS-ERC-EPOC INTUBACION -3
mymodel_erc_iot_3 <- glm(no_hospitalizado ~ renal_cirrosis_epoc+sexo+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_3, 3)+cardiovasc_diabetes+cancer+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_erc_iot_3)


erc_iot_3_or <- c(round(exp(coef(mymodel_erc_iot_3)),2)[2],
                             round(exp(coef(mymodel_erc_iot_3)-(1.96*0.12)),2)[2],
                            round(exp(coef(mymodel_erc_iot_3)+(1.96*0.12)),2)[2])

erc_iot_3_or_ic <- str_c(round(exp(coef(mymodel_erc_iot_3)),2)[2],
                            " (", round(exp(coef(mymodel_erc_iot_3)-(1.96*0.12)),2)[2], "-",
                            round(exp(coef(mymodel_erc_iot_3)+(1.96*0.12)),2)[2],")")


#CIRROSIS-ERC-EPOC INTUBACION -7
mymodel_erc_iot_7 <- glm(no_hospitalizado ~ renal_cirrosis_epoc+sexo+semana_epi+rcs(porcentaje_ocupadas_uti_fecha_7, 3)+cardiovasc_diabetes+cancer+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_erc_iot_7)

erc_iot_7_or <- c(round(exp(coef(mymodel_erc_iot_7)),2)[2],
                             round(exp(coef(mymodel_erc_iot_7)-(1.96*0.12)),2)[2],
                            round(exp(coef(mymodel_erc_iot_7)+(1.96*0.12)),2)[2])

erc_iot_7_or_ic <- str_c(round(exp(coef(mymodel_erc_iot_7)),2)[2],
                            " (", round(exp(coef(mymodel_erc_iot_7)-(1.96*0.12)),2)[2], "-",
                            round(exp(coef(mymodel_erc_iot_7)+(1.96*0.12)),2)[2],")")

#CIRROSIS-ERC-EPOC GENERAL MISMO DIA
mymodel_erc_gral <-glm(no_hospitalizado ~ renal_cirrosis_epoc+sexo+semana_epi+rcs(porcentaje_ocupadas_general_misma_fecha, 3)+cardiovasc_diabetes+cancer+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_erc_gral)

erc_gral_or <- c(round(exp(coef(mymodel_erc_gral)),2)[2],
                             round(exp(coef(mymodel_erc_gral)-(1.96*0.12)),2)[2],
                            round(exp(coef(mymodel_erc_gral)+(1.96*0.12)),2)[2])

erc_gral_or_ic <- str_c(round(exp(coef(mymodel_erc_gral)),2)[2],
                            " (", round(exp(coef(mymodel_erc_gral)-(1.96*0.12)),2)[2], "-",
                            round(exp(coef(mymodel_erc_gral)+(1.96*0.12)),2)[2],")")


#CIRROSIS-ERC-EPOC GENERAL -3
mymodel_erc_gral_3 <- glm(no_hospitalizado ~ renal_cirrosis_epoc+sexo+semana_epi+rcs(porcentaje_ocupadas_general_fecha_3, 3)+cardiovasc_diabetes+cancer+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_erc_gral_3)


erc_gral_3_or <- c(round(exp(coef(mymodel_erc_gral_3)),2)[2],
                             round(exp(coef(mymodel_erc_gral_3)-(1.96*0.12)),2)[2],
                            round(exp(coef(mymodel_erc_gral_3)+(1.96*0.12)),2)[2])

erc_gral_3_or_ic <- str_c(round(exp(coef(mymodel_erc_gral_3)),2)[2],
                            " (", round(exp(coef(mymodel_erc_gral_3)-(1.96*0.12)),2)[2], "-",
                            round(exp(coef(mymodel_erc_gral_3)+(1.96*0.12)),2)[2],")")


#CIRROSIS-ERC-EPOC GENERAL -7
mymodel_erc_gral_7 <- glm(no_hospitalizado ~ renal_cirrosis_epoc+sexo+semana_epi+rcs(porcentaje_ocupadas_general_fecha_7, 3)+cardiovasc_diabetes+cancer+rcs(edad, 3)+distrito, 
                          data = train, family = 'binomial')
summary(mymodel_erc_gral_7)


erc_gral_7_or <- c(round(exp(coef(mymodel_erc_gral_7)),2)[2],
                             round(exp(coef(mymodel_erc_gral_7)-(1.96*0.12)),2)[2],
                            round(exp(coef(mymodel_erc_gral_7)+(1.96*0.12)),2)[2])

erc_gral_7_or_ic <- str_c(round(exp(coef(mymodel_erc_gral_7)),2)[2],
                            " (", round(exp(coef(mymodel_erc_gral_7)-(1.96*0.12)),2)[2], "-",
                            round(exp(coef(mymodel_erc_gral_7)+(1.96*0.12)),2)[2],")")
```


```{r   log regression out-of-hospital death as outcome HOSPITAL SATURATION, include = F, warning= F}
#SATURACION INTUBACION MISMO DIA
mymodel_sat_iot <- glm(no_hospitalizado ~ rcs(porcentaje_ocupadas_uti_misma_fecha, 3)+semana_epi, 
                          data = train, family = 'binomial')
summary(mymodel_sat_iot)


lr_sat_iot <- termplot(mymodel_sat_iot, se=TRUE, plot = F)$porcentaje_ocupadas_uti_misma_fecha
center_sat_iot <- with(lr_sat_iot, y[x==50.2])
ci_sat_iot <- lr_sat_iot$y + outer(lr_sat_iot$se, c(0, -1.96, 1.96), '*')

sat_iot_df <- data.frame(sat = lr_sat_iot$x, 
                     y = lr_sat_iot$y,
                     se = lr_sat_iot$se,
                     lower_ci = ci_sat_iot[,2],
                     upper_ci = ci_sat_iot[,3],
                     mean_ci = ci_sat_iot[,1])


sat_iot_ors <- sat_iot_df[with(sat_iot_df, sat == 32 | sat == 40 | 
                         sat == 50.2 |sat== 60.1|sat== 70.5|sat== 80.1|sat== 90.3),] %>% 
  mutate(or = round(exp(y-center_sat_iot),2),
         lower_or = round(exp(lower_ci-center_sat_iot),2),
         upper_or = round(exp(upper_ci-center_sat_iot),2),
         full_or = str_c(round(exp(y-center_sat_iot),2), " (", round(exp(lower_ci-center_sat_iot),2),
                         "-", round(exp(upper_ci-center_sat_iot),2),")"))


#SATURACION INTUBACION -3
mymodel_sat_iot_3 <- glm(no_hospitalizado ~ rcs(porcentaje_ocupadas_uti_fecha_3, 3)+semana_epi, 
                          data = train, family = 'binomial')
summary(mymodel_sat_iot_3)


lr_sat_iot_3 <- termplot(mymodel_sat_iot_3, se=TRUE, plot = F)$porcentaje_ocupadas_uti_fecha_3
center_sat_iot_3 <- with(lr_sat_iot_3, y[x==50.2])
ci_sat_iot_3 <- lr_sat_iot_3$y + outer(lr_sat_iot_3$se, c(0, -1.96, 1.96), '*')

sat_iot_3_df <- data.frame(sat = lr_sat_iot_3$x, 
                     y = lr_sat_iot_3$y,
                     se = lr_sat_iot_3$se,
                     lower_ci = ci_sat_iot_3[,2],
                     upper_ci = ci_sat_iot_3[,3],
                     mean_ci = ci_sat_iot_3[,1])


sat_iot_3_ors <- sat_iot_3_df[with(sat_iot_3_df, sat == 32 | sat == 40 | 
                         sat == 50.2 |sat== 60.1|sat== 70.5|sat== 80.1|sat== 90.3),] %>% 
  mutate(or = round(exp(y-center_sat_iot_3),2),
         lower_or = round(exp(lower_ci-center_sat_iot_3),2),
         upper_or = round(exp(upper_ci-center_sat_iot_3),2),
         full_or = str_c(round(exp(y-center_sat_iot_3),2), " (", round(exp(lower_ci-center_sat_iot_3),2),
                         "-", round(exp(upper_ci-center_sat_iot_3),2),")"))


#SATURACION INTUBACION -7
mymodel_sat_iot_7 <- glm(no_hospitalizado ~ rcs(porcentaje_ocupadas_uti_fecha_7, 3)+semana_epi, 
                          data = train, family = 'binomial')
summary(mymodel_sat_iot_7)


lr_sat_iot_7 <- termplot(mymodel_sat_iot_7, se=TRUE, plot = F)$porcentaje_ocupadas_uti_fecha_7
center_sat_iot_7 <- with(lr_sat_iot_7, y[x==50.2])
ci_sat_iot_7 <- lr_sat_iot_7$y + outer(lr_sat_iot_7$se, c(0, -1.96, 1.96), '*')

sat_iot_7_df <- data.frame(sat = lr_sat_iot_7$x, 
                     y = lr_sat_iot_7$y,
                     se = lr_sat_iot_7$se,
                     lower_ci = ci_sat_iot_7[,2],
                     upper_ci = ci_sat_iot_7[,3],
                     mean_ci = ci_sat_iot_7[,1])


sat_iot_7_ors <- sat_iot_7_df[with(sat_iot_7_df, sat == 32 | sat == 40 | 
                         sat == 50.2 |sat== 60.1|sat== 70.5|sat== 80.1|sat== 90.3),] %>% 
  mutate(or = round(exp(y-center_sat_iot_7),2),
         lower_or = round(exp(lower_ci-center_sat_iot_7),2),
         upper_or = round(exp(upper_ci-center_sat_iot_7),2),
         full_or = str_c(round(exp(y-center_sat_iot_7),2), " (", round(exp(lower_ci-center_sat_iot_7),2),
                         "-", round(exp(upper_ci-center_sat_iot_7),2),")"))


#SATURACION GENERAL MISMA FECHA
mymodel_sat_gral <- glm(no_hospitalizado ~ rcs(porcentaje_ocupadas_general_misma_fecha, 3)+semana_epi, 
                          data = train, family = 'binomial')
summary(mymodel_sat_gral)


lr_sat_gral <- termplot(mymodel_sat_gral, se=TRUE, plot = F)$porcentaje_ocupadas_general_misma_fecha
center_sat_gral <- with(lr_sat_gral, y[x==50])
ci_sat_gral <- lr_sat_gral$y + outer(lr_sat_gral$se, c(0, -1.96, 1.96), '*')

sat_gral_df <- data.frame(sat = lr_sat_gral$x, 
                     y = lr_sat_gral$y,
                     se = lr_sat_gral$se,
                     lower_ci = ci_sat_gral[,2],
                     upper_ci = ci_sat_gral[,3],
                     mean_ci = ci_sat_gral[,1])


sat_gral_ors <- sat_gral_df[with(sat_gral_df, sat == 40.1 | 
                         sat == 50 |sat== 60.3|sat== 70.1|sat== 80.1|sat== 90),] %>% 
  mutate(or = round(exp(y-center_sat_gral),2),
         lower_or = round(exp(lower_ci-center_sat_gral),2),
         upper_or = round(exp(upper_ci-center_sat_gral),2),
         full_or = str_c(round(exp(y-center_sat_gral),2), " (", round(exp(lower_ci-center_sat_gral),2),
                         "-", round(exp(upper_ci-center_sat_gral),2),")"))


#SATURACION GENERAL -3
mymodel_sat_gral_3 <- glm(no_hospitalizado ~ rcs(porcentaje_ocupadas_general_fecha_3, 3)+semana_epi, 
                          data = train, family = 'binomial')
summary(mymodel_sat_gral_3)


lr_sat_gral_3 <- termplot(mymodel_sat_gral_3, se=TRUE, plot = F)$porcentaje_ocupadas_general_fecha_3
center_sat_gral_3 <- with(lr_sat_gral_3, y[x==50])
ci_sat_gral_3 <- lr_sat_gral_3$y + outer(lr_sat_gral_3$se, c(0, -1.96, 1.96), '*')

sat_gral_3_df <- data.frame(sat = lr_sat_gral_3$x, 
                     y = lr_sat_gral_3$y,
                     se = lr_sat_gral_3$se,
                     lower_ci = ci_sat_gral_3[,2],
                     upper_ci = ci_sat_gral_3[,3],
                     mean_ci = ci_sat_gral_3[,1])


sat_gral_3_ors <- sat_gral_3_df[with(sat_gral_3_df, sat == 40.1 | 
                         sat == 50 |sat== 60.3|sat== 70.1|sat== 80.1|sat== 90),] %>% 
  mutate(or = round(exp(y-center_sat_gral_3),2),
         lower_or = round(exp(lower_ci-center_sat_gral_3),2),
         upper_or = round(exp(upper_ci-center_sat_gral_3),2),
         full_or = str_c(round(exp(y-center_sat_gral_3),2), " (", round(exp(lower_ci-center_sat_gral_3),2),
                         "-", round(exp(upper_ci-center_sat_gral_3),2),")"))


#SATURACION GENERAL -7
mymodel_sat_gral_7 <- glm(no_hospitalizado ~ rcs(porcentaje_ocupadas_general_fecha_7, 3)+semana_epi, 
                          data = train, family = 'binomial')
summary(mymodel_sat_gral_7)


lr_sat_gral_7 <- termplot(mymodel_sat_gral_7, se=TRUE, plot = F)$porcentaje_ocupadas_general_fecha_7
center_sat_gral_7 <- with(lr_sat_gral_7, y[x==50])
ci_sat_gral_7 <- lr_sat_gral_3$y + outer(lr_sat_gral_7$se, c(0, -1.96, 1.96), '*')

sat_gral_7_df <- data.frame(sat = lr_sat_gral_7$x, 
                     y = lr_sat_gral_7$y,
                     se = lr_sat_gral_7$se,
                     lower_ci = ci_sat_gral_7[,2],
                     upper_ci = ci_sat_gral_7[,3],
                     mean_ci = ci_sat_gral_7[,1])


sat_gral_7_ors <- sat_gral_7_df[with(sat_gral_7_df, sat == 40.1 | 
                         sat == 50 |sat== 60.3|sat== 70.1|sat== 80.1|sat== 90),] %>% 
  mutate(or = round(exp(y-center_sat_gral_7),2),
         lower_or = round(exp(lower_ci-center_sat_gral_7),2),
         upper_or = round(exp(upper_ci-center_sat_gral_7),2),
         full_or = str_c(round(exp(y-center_sat_gral_7),2), " (", round(exp(lower_ci-center_sat_gral_7),2),
                         "-", round(exp(upper_ci-center_sat_gral_7),2),")"))

```


```{r   log regression out-of-hospital death as outcome EPI WEEK, include = F, warning= F}

mymodel_semana <- glm(no_hospitalizado ~ semana_epi, 
                          data = train, family = 'binomial')
summary(mymodel_semana)


lr_semana <- termplot(mymodel_semana, se=TRUE, plot = F)$semana_epi
center_semana <- with(lr_semana, y[x==40])
ci_semana <- lr_semana$y + outer(lr_semana$se, c(0, -1.96, 1.96), '*')

semana_df <- data.frame(semana = lr_semana$x, 
                     y = lr_semana$y,
                     se = lr_semana$se,
                     lower_ci = ci_semana[,2],
                     upper_ci = ci_semana[,3],
                     mean_ci = ci_semana[,1])


semana_ors <- semana_df[with(semana_df, semana == 20 | semana == 30 | 
                         semana == 40 |semana== 50|semana== 60),] %>% 
  mutate(or = round(exp(y-center_semana),2),
         lower_or = round(exp(lower_ci-center_semana),2),
         upper_or = round(exp(upper_ci-center_semana),2),
         full_or = str_c(round(exp(y-center_semana),2), " (", round(exp(lower_ci-center_semana),2),
                         "-", round(exp(upper_ci-center_semana),2),")"))
```


```{r table 1, include = F, warning = F}
table_1 <- group_by(base_final, lugarmuerte) %>% 
  summarise(n=n(),
            sexo_masc = str_c(sum(sexo=="MASCULINO"), " (",round(sum(sexo=="MASCULINO")/n, 3)*100, ")"),
            sexo_fem = str_c(sum(sexo=="FEMENINO"), " (",round(sum(sexo=="FEMENINO")/n, 3)*100, ")"),
            edad_mediana = str_c(median(edad, na.rm = T), " (", fivenum(edad, na.rm = T)[2], "-", fivenum(edad, na.rm = T)[4], ")"),
            diabetes = str_c(sum(diabetes), " (", round(sum(diabetes)/n, 3)*100, ")"),
            hipertension = str_c(sum(hipertension), " (", round(sum(hipertension)/n, 3)*100, ")"),
            enfermedad_cardio_vascular = str_c(sum(enfermedad_cardio_vascular), " (",
                                               round(sum(enfermedad_cardio_vascular)/n, 3)*100, ")"),
            cancer = str_c(sum(cancer), " (", round(sum(cancer)/n, 3)*100, ")"),
            enf_renal_cronica = str_c(sum(enf_renal_cronica), " (", round(sum(enf_renal_cronica)/
                                                                            n, 3)*100, ")"),
            cirrosis = str_c(sum(cirrosis), " (", round(sum(cirrosis)/n, 3)*100, ")"),
            epoc = str_c(sum(epoc), " (", round(sum(epoc)/n, 3)*100, ")"),
            distrito_fuera_cdmx = str_c(sum(distrito=="Fuera de cdmx", na.rm = T), " (",
                                        round(sum(distrito=="Fuera de cdmx", na.rm = T)/n, 3)*100, ")"),
            distrito_iztapalapa = str_c(sum(distrito=="IZTAPALAPA", na.rm = T), " (",
                                        round(sum(distrito=="IZTAPALAPA", na.rm = T)/n, 3)*100, ")"),
            distrito_gustavo = str_c(sum(distrito=="GUSTAVO A MADERO", na.rm = T), " (",
                                        round(sum(distrito=="GUSTAVO A MADERO", na.rm = T)/n, 3)*100, ")"),
            distrito_alvaro = str_c(sum(distrito=="ALVARO OBREGON", na.rm = T), " (",
                                        round(sum(distrito=="ALVARO OBREGON", na.rm = T)/n, 3)*100, ")"),
            distrito_cuauhtemoc = str_c(sum(distrito=="CUAUHTEMOC", na.rm = T), " (",
                                        round(sum(distrito=="CUAUHTEMOC", na.rm = T)/n, 3)*100, ")"),
            distrito_otro = str_c(sum(distrito!="CUAUHTEMOC"&distrito!="ALVARO OBREGON"&
                                        distrito!="GUSTAVO A MADERO"&distrito!="IZTAPALAPA"&
                                        distrito!="Fuera de cdmx", na.rm = T), " (",
                                        round(sum(distrito!="CUAUHTEMOC"&distrito!="ALVARO OBREGON"&
                                        distrito!="GUSTAVO A MADERO"&distrito!="IZTAPALAPA"&
                                        distrito!="Fuera de cdmx", na.rm = T)/n, 3)*100, ")")
            ) 



group_by(base_final, lugarmuerte) %>% 
  summarise(n=n(),
distrito_gustavo=str_c(sum(distrito=="GUSTAVO A MADERO", na.rm = T), " (",
                                        round(sum(distrito=="GUSTAVO A MADERO", na.rm = T)/n, 3)*100, ")"))
```


```{r table 2, include = F, warning = F}
table_2 <- data.frame(variables = c("Age", edad_ors$edad,
                                    "Sex",
                                    "Cardiovascular disease or diabetes", 
                                    "Any type of cancer", 
                                    "Chronic kidney disease, liver cirrhosis, or chronic obstructive pulmonary disease", 
                                    "Epidemiological week", semana_ors$semana,
                                              "Percentage occupation of intubation-capable beds",
                                    sat_iot_ors$sat,
                                              "Percentage occupation of general beds",
                                    sat_gral_ors$sat
                                              ),
                      or_ic = c(NA, edad_ors$full_or,
                                sex_or_ic,
                                cv_or_ic,
                                cancer_or_ic,
                                erc_or_ic,
                                NA, semana_ors$full_or,
                                NA, sat_iot_ors$full_or,
                                NA, sat_gral_ors$full_or))


```


```{r spline plots main text, include = F}
age_spline_plot <- ggplot(edad_df, aes(x = edad, 
                                                        y = exp(y - center_edad))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_edad)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_edad)), size = .8) +
  ylab("OR of death out of a hospital") +
  xlab("Age")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(20,90,10),
                     limits = c(20, 90))


iot_spline_plot <- ggplot(sat_iot_df, aes(x = sat, 
                                                        y = exp(y - center_sat_iot))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_sat_iot)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_sat_iot)), size = .8) +
  ylab("OR of death out of a hospital") +
  xlab("% occupancy")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(30,90,10),
                     limits = c(35, 90))


gral_spline_plot <- ggplot(sat_gral_df, aes(x = sat, 
                                                        y = exp(y - center_sat_gral))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_sat_gral)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_sat_gral)), size = .8) +
  ylab("OR of death out of a hospital") +
  xlab("% occupancy")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(30,90,10),
                     limits = c(35, 90))


semana_spline_plot <- ggplot(semana_df, aes(x = semana, 
                                                        y = exp(y - center_semana))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_semana)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_semana)), size = .8) +
  ylab("OR of death out of a hospital") +
  xlab("Epidemiological week")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(10,60,10),
                     limits = c(10, 60))



combined_plot_main_text <- age_spline_plot+semana_spline_plot+iot_spline_plot+
  gral_spline_plot+
  plot_annotation(tag_levels = 'A')#Guardar en tamaño 8x8


```


```{r sensitivity analyses table 2, include = F, warning=F}
supp_table_2 <- data.frame(variables = c("Age", edad_ors$edad,
                                    "Sex",
                                    "Cardiovascular disease or diabetes", 
                                    "Any type of cancer", 
                                    "Chronic kidney disease, liver cirrhosis, or chronic obstructive pulmonary disease"),
                      or_ic_base = c(NA, edad_ors$full_or,
                                sex_or_ic,
                                cv_or_ic,
                                cancer_or_ic,
                                erc_or_ic),
                      or_ic_fecha_3 = c(NA, edad_ors_fecha_3$full_or,
                                sex_iot_3_or_ic,
                                cv_iot_3_or_ic,
                                cancer_iot_3_or_ic,
                                erc_iot_3_or_ic),
                      or_ic_fecha_7 = c(NA, edad_ors_fecha_7$full_or,
                                sex_iot_7_or_ic,
                                cv_iot_7_or_ic,
                                cancer_iot_7_or_ic,
                                erc_iot_7_or_ic),
                      or_ic_gral = c(NA, edad_ors_gr$full_or,
                                sex_gral_or_ic,
                                cv_gral_or_ic,
                                cancer_gral_or_ic,
                                erc_gral_or_ic),
                      or_ic_fecha_3_gral = c(NA, edad_ors_fecha_3_gr$full_or,
                                sex_gral_3_or_ic,
                                cv_gral_3_or_ic,
                                cancer_gral_3_or_ic,
                                erc_gral_3_or_ic),
                      or_ic_fecha_7_gral = c(NA, edad_ors_fecha_7_gr$full_or,
                                sex_gral_7_or_ic,
                                cv_gral_7_or_ic,
                                cancer_gral_7_or_ic,
                                erc_gral_7_or_ic))
```


```{r sensitivity analyses table 3, include = F, warning=F}
supp_table_3 <- data.frame(variables = c("Percentage occupation of intubation-capable beds",
                                    sat_iot_ors$sat[c(2,3,5,7)]),
                      or_ic_base = c(NA, sat_iot_ors$full_or[c(2,3,5,7)]),
                      or_ic_fecha_3 = c(NA, sat_iot_3_ors$full_or[c(2,3,5,7)]),
                      or_ic_fecha_7 = c(NA, sat_iot_7_ors$full_or[c(2,3,5,7)]),
                      or_ic_gral = c(NA, sat_gral_ors$full_or[c(1,2,4,6)]),
                      or_ic_fecha_3_gral = c(NA, sat_gral_3_ors$full_or[c(1,2,4,6)]),
                      or_ic_fecha_7_gral = c(NA, sat_gral_7_ors$full_or[c(1,2,4,6)]))
```


```{r spline plots supplementary text, include = F}
age_spline_plot <- ggplot(edad_df, aes(x = edad, 
                                                        y = exp(y - center_edad))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_edad)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_edad)), size = .8) +
  ylab("OR of death at home") +
  xlab("Age")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(20,90,10),
                     limits = c(20, 90))

age_spline_plot_col <- ggplot(edad_df, aes(x = edad, #Save as 4x6
                                                        y = exp(y - center_edad))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "darkred", size = 1.2) +
  geom_smooth(se = F, colour = "darkred", linetype = "dashed", 
              aes(y = exp(upper_ci - center_edad)), size = .8) +
  geom_smooth(se = F, colour = "darkred", linetype = "dashed", 
              aes(y = exp(lower_ci - center_edad)), size = .8) +
  ylab("OR of death at home") +
  xlab("Age")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(20,90,10),
                     limits = c(20, 90))

age_spline_plot_fecha_3 <- ggplot(edad_df_fecha_3, aes(x = edad, 
                                                        y = exp(y - center_edad_fecha_3))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_edad)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_edad)), size = .8) +
  ylab("OR of death at home") +
  xlab("Age")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(20,90,10),
                     limits = c(20, 90))

age_spline_plot_fecha_7 <- ggplot(edad_df_fecha_7, aes(x = edad, 
                                                        y = exp(y - center_edad_fecha_7))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_edad)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_edad)), size = .8) +
  ylab("OR of death at home") +
  xlab("Age")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(20,90,10),
                     limits = c(20, 90))

#CAMAS GENERALES
age_spline_plot_gr <- ggplot(edad_df_gr, aes(x = edad, 
                                                        y = exp(y - center_edad_gr))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_edad)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_edad)), size = .8) +
  ylab("OR of death at home") +
  xlab("Age")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(20,90,10),
                     limits = c(20, 90))

age_spline_plot_fecha_3_gr <- ggplot(edad_df_fecha_3_gr, aes(x = edad, 
                                                        y = exp(y - center_edad_fecha_3_gr))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_edad)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_edad)), size = .8) +
  ylab("OR of death at home") +
  xlab("Age")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(20,90,10),
                     limits = c(20, 90))

age_spline_plot_fecha_7_gr <- ggplot(edad_df_fecha_7_gr, aes(x = edad, 
                                                        y = exp(y - center_edad_fecha_7_gr))) +
  geom_hline(yintercept = seq(from = 0.5, to = 5, by = .5), colour = "lightgray") +
  geom_hline(yintercept=1, colour = "black", size = .7)+
  geom_smooth(se = F, colour = "black", size = 1.2) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(upper_ci - center_edad)), size = .8) +
  geom_smooth(se = F, colour = "black", linetype = "dashed", 
              aes(y = exp(lower_ci - center_edad)), size = .8) +
  ylab("OR of death at home") +
  xlab("Age")+
  theme_light()+
  theme(axis.text.x = element_text(size = 14, face = "bold", colour="black"),
        axis.title.x = element_text(face = "bold", size = 14),
        axis.ticks = element_line(size = 1, colour = "black"),
        axis.title.y = element_text(face = "bold", size = 14),
        axis.text.y = element_text(size = 14, face = "bold", colour = "black"),
        plot.title = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"))+
  scale_y_continuous(limits = c(0, 4))+
  scale_x_continuous(breaks = seq(20,90,10),
                     limits = c(20, 90))


combined_plot_ <- age_spline_plot_fecha_3+age_spline_plot_fecha_7+age_spline_plot_gr+age_spline_plot_fecha_3_gr+age_spline_plot_fecha_7_gr+
  plot_annotation(tag_levels = 'A')
```


```{r texto del artículo, include = F}
table(base_final$no_hospitalizado)
table(base_final$no_hospitalizado)

fivenum(base_final$edad, na.rm = T)

fivenum(filter(base_final, no_hospitalizado == T)$edad, na.rm = T)

fivenum(filter(base_final, no_hospitalizado == F)$edad, na.rm = T)
table(base_final$sexo)
table(base_final$sexo)/nrow(base_final)

table(SEXO=base_final$sexo,
      NO_HOSP=base_final$no_hospitalizado)

22134/(13128+22134)
41371/(16745+41371)

range(base_final$daily_cases)


range(base_final$daily_cases)
```
